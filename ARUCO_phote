import cv2
import numpy as np
from cv2 import aruco

# ==== ArUco è®¾ç½® ====
ARUCO_DICT = aruco.Dictionary_get(aruco.DICT_4X4_50)
ARUCO_PARAMS = aruco.DetectorParameters_create()
ARUCO_PARAMS.cornerRefinementMethod = aruco.CORNER_REFINE_SUBPIX
ARUCO_PARAMS.adaptiveThreshWinSizeMin = 3
ARUCO_PARAMS.adaptiveThreshWinSizeMax = 23
ARUCO_PARAMS.adaptiveThreshWinSizeStep = 10


# ==== æ‘„åƒå¤´åˆå§‹åŒ– ====
cap = cv2.VideoCapture(0)
if not cap.isOpened():
    print("æ‘„åƒå¤´æ— æ³•æ‰“å¼€")
    exit()

# ==== æ‹ä¸€å¼ åˆå§‹ç…§ç‰‡ ====
print("ğŸ“¸ æ­£åœ¨æ‹æ‘„åˆå§‹å¸§è¯†åˆ« ArUco...")
ret, init_frame = cap.read()
if not ret:
    print("âŒ æ‹ç…§å¤±è´¥")
    exit()

gray_init = cv2.cvtColor(init_frame, cv2.COLOR_BGR2GRAY)
corners, ids, _ = aruco.detectMarkers(gray_init, ARUCO_DICT, parameters=ARUCO_PARAMS)

roi_dict = {}  # å­˜å‚¨æ¯ä¸ª ID çš„ ROI åŒºåŸŸ (x1, y1, x2, y2)
ROI_MARGIN = 80  # ROI åŒºåŸŸå¤§å°æ‰©å±•é‡ï¼ˆä¸Šä¸‹å·¦å³å„æ‰©å±•ï¼‰

if ids is not None:
    for i, marker_id in enumerate(ids.flatten()):
        if 0 <= marker_id <= 3:
            pts = corners[i][0]
            cx = int(np.mean(pts[:, 0]))
            cy = int(np.mean(pts[:, 1]))
            x1 = max(0, cx - ROI_MARGIN)
            y1 = max(0, cy - ROI_MARGIN)
            x2 = min(init_frame.shape[1], cx + ROI_MARGIN)
            y2 = min(init_frame.shape[0], cy + ROI_MARGIN)
            roi_dict[marker_id] = (x1, y1, x2, y2)
else:
    print("âŒ æ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½• ArUco marker (0~3)")
    exit()

print(f"âœ… åˆå§‹è¯†åˆ«å®Œæˆï¼Œæ£€æµ‹åˆ° {len(roi_dict)} ä¸ª markerã€‚")

# ==== å®æ—¶å¤„ç†è§†é¢‘å¸§ ====
while True:
    ret, frame = cap.read()
    if not ret:
        break

    # ==== éå†æ¯ä¸ª ROIï¼Œæ£€æµ‹ç‰¹å®š ID ====
    for marker_id in range(4):
        if marker_id not in roi_dict:
            continue
        x1, y1, x2, y2 = roi_dict[marker_id]
        roi_gray = cv2.cvtColor(frame[y1:y2, x1:x2], cv2.COLOR_BGR2GRAY)
        roi_corners, roi_ids, _ = aruco.detectMarkers(roi_gray, ARUCO_DICT, parameters=ARUCO_PARAMS)

        if roi_ids is not None:
            for i, detected_id in enumerate(roi_ids.flatten()):
                if detected_id == marker_id:
                    abs_corners = roi_corners[i].astype(np.float32) + np.array([[[x1, y1]]], dtype=np.float32)
                    aruco.drawDetectedMarkers(frame, [abs_corners], np.array([detected_id]))

                    pts = abs_corners[0]
                    cx = int(np.mean(pts[:, 0]))
                    cy = int(np.mean(pts[:, 1]))
                    cv2.circle(frame, (cx, cy), 4, (0, 255, 0), -1)
                    cv2.putText(frame, f"ID: {detected_id}", (cx + 10, cy - 10),
                                cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 0), 1)

        # ç”» ROI è¾…åŠ©æ¡†
        cv2.rectangle(frame, (x1, y1), (x2, y2), (255, 255, 0), 1)

    # æ˜¾ç¤ºç¼©æ”¾ç”»é¢
    resized = cv2.resize(frame, (640, 360))
    cv2.imshow("Fast ArUco Tracking (ROI Based)", resized)

    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
